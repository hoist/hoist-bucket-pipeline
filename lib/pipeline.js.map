{"version":3,"sources":["pipeline.js"],"names":[],"mappings":"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","file":"pipeline.js","sourcesContent":["'use strict';\nimport Errors from '@hoist/errors';\nimport logger from '@hoist/logger';\nimport Context from '@hoist/context';\nimport {\n  Bucket\n}\nfrom '@hoist/model';\n\nimport {\n  extend\n}\nfrom 'lodash';\n\n/**\n * Pipeline class for interacting with Buckets\n */\nclass Pipeline {\n  /**\n   * create a new Pipeline\n   */\n  constructor() {\n    this._logger = logger.child({\n      cls: this.constructor.name\n    });\n  }\n  _addHelper(key, meta) {\n    return Context.get().then((context) => {\n      var options = {\n        application: context.application._id,\n        environment: context.environment\n      };\n      if (key) {\n        options.key = key;\n      }\n      if (meta) {\n        options.meta = meta;\n      } else {\n        options.meta = {};\n      }\n      var newBucket = this._createBucket(options);\n      return newBucket.saveAsync().then((bucket) => {\n        return bucket.toObject();\n      });\n    });\n  }\n  _createBucket(options) {\n    return new Bucket(options);\n  }\n  _saveMetaHelper(bucket, meta) {\n    if (bucket) {\n      if (bucket.meta) {\n        bucket.meta = extend(bucket.meta, meta);\n      } else {\n        bucket.meta = meta;\n      }\n      bucket.markModified('meta');\n      return bucket.saveAsync().then((results) => {\n        return results[0].meta;\n      });\n    }\n    throw new Errors.bucket.NotFoundError();\n  }\n\n  /**\n   * add a new bucket and set the meta data\n   * @param {String} key - the unique key for the bucket\n   * @param {Object} [meta] - any mata data to save\n   * @returns {Promise<Object>} - the Bucket in object form\n   */\n  add(key, meta) {\n      if (!meta && typeof key === 'object') {\n        meta = key;\n        key = null;\n      }\n      if (key) {\n        this._logger.info('resolving context');\n        return Context.get().then((context) => {\n          this._logger.info({\n            context: context\n          }, 'looking up bucket');\n          return Bucket.findOneAsync({\n              key: key,\n              environment: context.environment,\n              application: context.application._id\n            })\n            .then((bucket) => {\n              if (bucket) {\n                throw new Errors.bucket.InvalidError('A bucket with key \"' + key + '\" already exists');\n              }\n              return this._addHelper(key, meta);\n            });\n        });\n      }\n      return this._addHelper(key, meta);\n    }\n    /**\n     * load the bucket specified from the database or create it\n     * and set it as the current bucket\n     * @param {String} key - the unique key for the bucket\n     * @param {Boolean} [create=false] - should we create the bucket?\n     * @returns {Promise<Object>} - the Bucket in object form\n     */\n  set(key, create) {\n    var self = this;\n    this._logger.info('resolving context');\n    return Context.get()\n      .then((context) => {\n        this._logger.info({\n          context: context\n        }, 'looking up bucket');\n        return Bucket.findOneAsync({\n            key: key,\n            environment: context.environment,\n            application: context.application._id\n          })\n          .then((bucket) => {\n            this._logger.info({\n              bucket: bucket\n            }, 'bucket lookup complete');\n            if (bucket) {\n              return (context.bucket = bucket.toObject());\n            }\n            if (create) {\n              return self.add(key).then((addedBucket) => {\n                if (addedBucket) {\n                  //add returns an object so don't call to object here\n                  return (context.bucket = addedBucket);\n                }\n                throw new Errors.bucket.SaveError();\n              });\n            }\n            throw new Errors.bucket.NotFoundError();\n          });\n      });\n  }\n\n  /**\n   * get a new bucket from the database\n   * @param {String} key - the unique key for the bucket\n   * @returns {Promise<Object>} - the Bucket in object form\n   */\n  get(key) {\n    return Context.get()\n      .then((context) => {\n        if (key) {\n          return Bucket.findOneAsync({\n              key: key,\n              environment: context.environment,\n              application: context.application._id\n            })\n            .then((bucket) => {\n              if (bucket) {\n                return bucket.toObject();\n              }\n              throw new Errors.bucket.NotFoundError();\n            });\n        }\n        if (context.bucket) {\n          return Bucket.findOneAsync({\n            key: context.bucket.key,\n            environment: context.environment,\n            application: context.application._id\n          }).then((bucket) => {\n            if (bucket) {\n              return bucket.toObject();\n            }\n            throw new Errors.bucket.NotFoundError();\n          });\n        }\n        return null;\n      });\n  }\n\n  /**\n   * remove bucket from the database\n   * @param {String} key - the unique key for the bucket\n   * @returns {Promise} - the Promise to have deleted the bucket\n   */\n  remove(key) {\n    return Context.get()\n      .then((context) => {\n        if (key) {\n          return Bucket.removeAsync({\n            key: key,\n            environment: context.environment,\n            application: context.application._id\n          }).then(() => {\n            if (context.bucket && context.bucket.key === key) {\n              context.bucket = null;\n            }\n          });\n        }\n        if (context.bucket) {\n          return Bucket.removeAsync({\n            key: context.bucket.key,\n            environment: context.environment,\n            application: context.application._id\n          }).then(() => {\n            context.bucket = null;\n          });\n        }\n        return null;\n\n      });\n  }\n\n  /**\n   * get all application buckets from the database\n   * @returns {Promise<Array<Object>>} - an Array of Buckets in object form\n   */\n  getAll() {\n    return Context.get()\n      .then((context) => {\n        return Bucket.findAsync({\n          environment: context.environment,\n          application: context.application._id\n        }).then((buckets) => {\n          return buckets.map((bucket) => {\n            return bucket.toObject();\n          });\n        });\n      });\n  }\n\n  /**\n   * run a function over every bucket in the organisation\n   * @param {function(Bucket: bucket)} fn - the function to run\n   * @returns {Promise} - promise to have run the function over each bucket\n   */\n  each(fn) {\n    return this.getAll().then((buckets) => {\n      return Promise.all(buckets.map((bucket) => {\n        return Promise.resolve(fn(bucket));\n      }));\n    });\n  }\n\n  /**\n   * sets and replaces meta data against a bucket\n   * @param {Object} meta - the mata data to save\n   * @param {String} [key] - the unique key for the bucket, if not set use the current context bucket\n   * @returns {Promise<Object>} - the Bucket in object form\n   */\n  saveMeta(meta, key) {\n    return Context.get()\n      .then((context) => {\n        if (key) {\n          return Bucket.findOneAsync({\n              key: key,\n              environment: context.environment,\n              application: context.application._id\n            })\n            .then((bucket) => {\n              return this._saveMetaHelper(bucket, meta);\n            });\n        }\n        if (context.bucket) {\n          return Bucket.findOneAsync({\n            key: context.bucket.key,\n            environment: context.environment,\n            application: context.application._id\n          }).then((bucket) => {\n            return this._saveMetaHelper(bucket, meta);\n          });\n        }\n        throw new Errors.bucket.NotFoundError();\n      });\n  }\n}\n\nexport default Pipeline;\n"],"sourceRoot":"/source/"}